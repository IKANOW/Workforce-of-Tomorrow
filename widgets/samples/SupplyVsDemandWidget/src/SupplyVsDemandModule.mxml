<mx:Module xmlns:fx="http://ns.adobe.com/mxml/2009" 
		   xmlns:s="library://ns.adobe.com/flex/spark" 
		   xmlns:mx="library://ns.adobe.com/flex/mx" layout="absolute"
		   implements="com.ikanow.infinit.e.widget.library.widget.IWidget">
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<fx:Style source="../com/ikanow/infinit/e/assets/styles/infiniteDefaultStyle.css" />
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		@namespace mx "library://ns.adobe.com/flex/mx";
		/* If you need to override a style in our stylesheet, or add another
		style that we did not support you can do so here, an example has been commented out
		Please see documentation about over-riding MX component styles to display fonts*/
		/*
		mx|Text
		{
		font-family: infiniteNonCFFFont;
		}
		*/
	</fx:Style>
	<fx:Script>
		<![CDATA[
			import com.ikanow.infinit.e.widget.library.utility.JSONDecoder;
			import com.ikanow.infinit.e.widget.library.widget.IWidgetContext;	
			import mx.collections.ArrayCollection;
			import mx.collections.XMLListCollection;
			import mx.controls.Alert;
			import mx.controls.Tree;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;			
			import org.alivepdf.pdf.PDF;
			
			private var _context:IWidgetContext;
			private var titleArray:ArrayCollection = new ArrayCollection();
			private var widgetOptions:Object = null;
			
			// Just used in samples (will be feed in via properties)
			private var API_SERVER:String = "http://infinite.wfot.ikanow.com/api/";
			
			// Create a data collection array that will allow the chart to be displayed
			[Bindable]private var dataCollection:ArrayCollection;
			
			
			/**
			 * Method fired when module is done loading.  Sends
			 * message to parent letting it know that module is
			 * ready to receive data.
			 */
			private function onWidgetCreationComplete():void
			{
				var events:Event = new Event("Done Loading");
				dispatchEvent(events);
			}
			
			/**
			 * IWidget interface to receive data object (IWidgetContext).
			 * Store the iwidgetcontext so we can receieve data later.
			 */
			public function onInit(context:IWidgetContext):void
			{
				_context = context;
				
				// Specifies the Rest Endpoint to Call
				infiniteWorkforceService.url = API_SERVER + "knowledge/mapreduce/getresults/irs_workforce_year_opdiv";
				infiniteWorkforceService.send();
				
			}
			
			/**
			 * IWidget interface that fires when a new query is done.
			 * We can access the data from the query by using our
			 * iwidgetcontext object context.getQuery_TopResults().getTopDocuments();
			 */
			public function onReceiveNewQuery():void
			{
				
			}
			
			
			/**
			 * Populates the division information into a format the chart can read
			 *  and sums up the campus data based on the assumption that these should be summed
			 */
			private function populateSupply(obj:Object, year:String, opdiv:String, begempcnt:String):void {
				
				// set up the year
				obj.year = year;
				
				
				
				// Makes the assumption that we want to roll up campus
				if ( (opdiv == "W_I") || (opdiv == "WICAMP") || (opdiv == "TEGE") || (opdiv == "SBSE") || (opdiv == "SBSECAMP") || (opdiv == "LB_I") ) {
				
					// Create the total aggregate count
					if ( obj.aggregate != null ) {
						obj.aggregate = String(parseFloat(begempcnt) + parseFloat(obj.aggregate));
					} else {
						obj.aggregate = begempcnt;
					}
					
					if ( (opdiv == "W_I") || (opdiv == "WICAMP") ){										
						if ( obj.W_I != null ) {
							obj.W_I = String(parseFloat(begempcnt) + parseFloat(obj.W_I));	
							obj.W_I_AGGR = true;
						} else {
							obj.W_I = begempcnt;
						}
					}
					if (opdiv == "TEGE") {
						obj.TEGE = begempcnt;
					}
					if ( (opdiv == "SBSE") || (opdiv == "SBSECAMP") ) {
						if ( obj.SBSE != null ) {
							obj.SBSE = String(parseFloat(begempcnt) + parseFloat(obj.SBSE));
							obj.SBSE_AGGR = true;
						} else {
							obj.SBSE = begempcnt;
						}
						
					}
					if (opdiv == "LB_I") {
						obj.LB_I = begempcnt;
					}
					
				} 
					// rolls up the overhead
				else {
					if ( obj.OH != null ) {
						obj.OH = String(parseFloat(begempcnt) + parseFloat(obj.OH));
					} 
					else {
						obj.OH = begempcnt;
					}
				}
				// verify all the data is present
				if ( ( obj != null ) && ( obj.aggregate != null ) && ( obj.OH != null ) && ( obj.W_I != null ) && ( obj.W_I_AGGR != null ) && ( obj.TEGE != null ) && ( obj.SBSE != null )  && ( obj.SBSE_AGGR != null ) && ( obj.LB_I !=  null ) ) {
					obj.full = true;
				}	
				
			}
			
			/**
			 * Hardcoded for sample purposes (illustration) 
			 * values take from FTEForcast Spreadsheet
			 */
			private function populateDemand(obj:Object):void {
				if (obj.year == "2011") {
					obj.LB_I_DEMAND = 6838.105;
					obj.SBSE_DEMAND = 3700.75;
					obj.TEGE_DEMAND = 1661.87;
					obj.W_I_DEMAND = 13476.05;
					obj.aggregate_DEMAND = 25676.775;
				}
				if (obj.year == "2012") {
					obj.LB_I_DEMAND = 6973.709;
					obj.SBSE_DEMAND = 3757.61;
					obj.TEGE_DEMAND = 1674.2;
					obj.W_I_DEMAND = 13345.43;
					obj.aggregate_DEMAND = 25750.949;
				}
				if (obj.year == "2013") {
					obj.LB_I_DEMAND = 7268.459;
					obj.SBSE_DEMAND = 3805.57;
					obj.TEGE_DEMAND = 1681.61;
					obj.W_I_DEMAND = 13484.83;	
					obj.aggregate_DEMAND = 26051.345;
				}
				if (obj.year == "2014") {
					obj.LB_I_DEMAND = 7268.459;	
					obj.SBSE_DEMAND = 3856.87;			
					obj.TEGE_DEMAND = 1689.57;
					obj.W_I_DEMAND = 13643.16;
					obj.aggregate_DEMAND = 26458.059;
				}
				if (obj.year == "2015") {
					obj.LB_I_DEMAND = 7456.158;
					obj.SBSE_DEMAND = 3909.71;
					obj.TEGE_DEMAND = 1696.82;
					obj.W_I_DEMAND = 13824.67;
					obj.aggregate_DEMAND = 26887.358;
				}
				
			}
			
			
			/**
			 * Result event for mapreduce call, checks if it was successful then formats json
			 * response to XML to be displayed in a flex tree.
			 */
			protected function infiniteWorkforceServiceResult(event:ResultEvent):void
			{					
				var data:Object = JSONDecoder.decode(event.result as String);
				if ( data.response.success.toString() == "true" )
				{
					
					// Get the JSON Data from the Infinit.e Service
					var dataJson:Object = JSONDecoder.decode(event.result as String);
					// Establish a data collection to contain that will serve as the source of data for the chart
					dataCollection = new ArrayCollection();
					
					if ( dataJson.response.success.toString() == "true" )
					{
						var obj:Object = new Object
						// here is where you load up the data after the service call
						for each(var i:Object in dataJson.data.results)
						{
							
							// Verify year is not null
							if (i._id.year != null)
							{	
								populateSupply(obj, i._id.year.toString(), i._id.op_div.toString(), i.value.begempcnt.toString());
								
								// verify all the data is present
								if ( ( obj != null ) && ( obj.full != null ) ) {
									
									// add demand data
									populateDemand(obj);
									
									// push it to the array collection
									dataCollection.source.push(obj);
									// rest the object
									obj = new Object;
								}
							}
							
						}
												
						// Add the data to chart
						chart.dataProvider = dataCollection;
						
					}
					else
					{
						cursorManager.removeAllCursors();
						Alert.show("Error retrieving Data.\n " + (data.response.message as String));
					}				
					
					
				}
				else
				{
					cursorManager.removeAllCursors();
					Alert.show("Error retrieving Data.\n " + (data.response.message as String));
				}				
			}
			
			
			/**
			 * Error sending API request.
			 */
			protected function infiniteWorkforceServiceFault(event:FaultEvent):void
			{
				cursorManager.removeAllCursors();
				Alert.show("Error retrieving Workforce Data\n" + event.fault.message);
			}
			
			/**
			 * @returns A list of supported formats, displayed in a context menu in the format
			 * "Export <string>" - these are called with "onGenerateExportData"
			 * Note this doesn't cover the "built-in" Alive PDF export.
			 * However if the developer specifies PDF and onGeneratePdf() returns non-null then this will be used.
			 */
			
			public function supportedExportFormats():ArrayCollection
			{
				var ac:ArrayCollection = new ArrayCollection();
				return ac;
			}
			/**
			 * function to build a pdf version of the widget
			 * 
			 * @return pdf version of the widget 
			 */
			public function onGeneratePDF(printPDF:PDF, title:String):PDF
			{
				return null;
			}
			
			/**
			 * function to rescale the module when the parent container is being resized
			 * 
			 * @param newHeight The new height the component needs to be set to
			 * @param newWidth The new width the component needs to be set to
			 */ 
			public function onParentResize(newHeight:Number,newWidth:Number):void
			{
				this.height = newHeight;
				this.width = newWidth;
			}
			
			/**
			 * This function gets called when the workspace is being saved.
			 * return null if no save string is needed.
			 * 
			 * @return a string this widget can use to reload state
			 */
			public function onSaveWidgetOptions():Object
			{
				return null;
			}
			
			/**
			 * Allow users to export the widget contents in the specified format
			 * @format filename: the filename+path to which the data will be written (in case it needs to be embedded)
			 * @param format: the format from the "supportedFormats" call
			 * 
			 * @returns a ByteArray containing the data to output
			 */
			public function onGenerateExportData(filename:String, format:String):ByteArray
			{
				return null;
			}
			
			/**
			 * IWidget interface that fires when a new filter is done (including from ourself)
			 * We can access the data fromt he filter by using our
			 * iwidgetcontext object _context.getQuery_FilteredResults().getTopDocuments();
			 */  
			public function onReceiveNewFilter():void
			{
				//get filtered logic here
				_context.getQuery_FilteredResults().getTopDocuments();
			}
			
			/**
			 * If a save string has been saved from 'getSaveString' then
			 * when the app gets reloaded the last save string
			 * will be passed to this function.
			 * 
			 * @param saveString the last save string or null if there was none
			 */
			public function onLoadWidgetOptions(widgetOptions:Object):void
			{
				this.widgetOptions = widgetOptions;
			}
		]]>
	</fx:Script>
	<fx:Declarations>
		<s:HTTPService id="infiniteWorkforceService"
					   result="infiniteWorkforceServiceResult(event)"
					   fault="infiniteWorkforceServiceFault(event)"/>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
		
	</fx:Declarations>
	
	
	
	<s:VGroup width="100%" height="100%" verticalAlign="middle" horizontalAlign="center" 
			  paddingBottom="5" paddingLeft="5" paddingRight="5" paddingTop="5">
		<s:HGroup width="100%" height="100%" verticalAlign="top" horizontalAlign="center">
			<mx:LineChart id="chart" 
						  showDataTips="true" 
						  width="100%" height="100%">
				<mx:horizontalAxis>
					<mx:CategoryAxis           
						categoryField="year"
						displayName="Year"/>
				</mx:horizontalAxis>
				<mx:series>
					<mx:LineSeries yField="aggregate" displayName="Aggregate Supply">
						<mx:lineStroke>
							<mx:Stroke color="red" weight="6" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>
					<mx:LineSeries yField="aggregate_DEMAND" displayName="Aggregate Demand">
						<mx:lineStroke>
							<mx:Stroke color="red" weight="6" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>
					
					<mx:LineSeries yField="W_I" displayName="W-I Supply">
						<mx:lineStroke>
							<mx:Stroke color="blue" weight="3" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>
					<mx:LineSeries yField="W_I_DEMAND" displayName="W-I Demand">
						<mx:lineStroke>
							<mx:Stroke color="blue" weight="3" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>
					
					<mx:LineSeries yField="LB_I" displayName="LB-I Supply">
					<mx:lineStroke>
						<mx:Stroke color="green" weight="3" alpha="1"/>
					</mx:lineStroke>
					</mx:LineSeries>
					<mx:LineSeries yField="LB_I_DEMAND" displayName="LB-I Demand">
						<mx:lineStroke>
							<mx:Stroke color="green" weight="3" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>	
					
					<mx:LineSeries yField="SBSE" displayName="SBSE Supply">
					<mx:lineStroke>
						<mx:Stroke color="black" weight="3" alpha="1"/>
					</mx:lineStroke>
					</mx:LineSeries>
					<mx:LineSeries yField="SBSE_DEMAND" displayName="SBSE Demand">
						<mx:lineStroke>
							<mx:Stroke color="black" weight="3" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>	
					
					<mx:LineSeries yField="TEGE" displayName="TEGE Supply">
						<mx:lineStroke>
							<mx:Stroke color="purple" weight="3" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>
					<mx:LineSeries yField="TEGE_DEMAND" displayName="TEGE Demand">
						<mx:lineStroke>
							<mx:Stroke color="purple" weight="3" alpha="1"/>
						</mx:lineStroke>
					</mx:LineSeries>
					
				</mx:series>
			</mx:LineChart>
			<mx:Legend dataProvider="{chart}"/>
		</s:HGroup>
		
		
	</s:VGroup>
</mx:Module>
